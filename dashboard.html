<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>NOVA ADS · لوحة القيادة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, sans-serif; }
        body { background: #f0f4fa; padding: 16px; padding-bottom: 80px; }
        .header { display: flex; align-items: center; gap: 12px; background: white; padding: 16px; border-radius: 30px; margin-bottom: 20px; }
        .logo { width: 56px; height: 56px; background: #102a43; border-radius: 18px; overflow: hidden; }
        .logo img { width: 100%; height: 100%; object-fit: cover; }
        .title { font-size: 24px; font-weight: 700; color: #0b2a41; }
        .sub { font-size: 14px; color: #5a7184; }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        .info-card {
            background: white;
            border-radius: 30px;
            padding: 22px 12px;
            text-align: center;
            box-shadow: 0 8px 18px rgba(0,0,0,0.02);
        }
        .info-card .number { font-size: 34px; font-weight: 800; color: #0b2a41; }
        .info-card .label { font-size: 14px; color: #5b7492; margin-top: 6px; }

        .chart-container {
            background: white;
            border-radius: 40px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .alert-card {
            background: #fff3d1;
            border-radius: 30px;
            padding: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #8e6100;
        }
        .alert-card i { font-size: 30px; }

        .recent-row {
            background: white;
            border-radius: 30px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex;
            justify-content: space-around; padding: 12px 16px 20px; border-radius: 40px 40px 0 0;
            border-top: 1px solid #edf2f9;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #7f8fa4; font-size: 12px; gap: 4px; }
        .nav-item i { font-size: 24px; }
        .nav-item.active { color: #1e4a8b; font-weight: 600; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo"><img src="img/logo.png" alt="NOVA"></div>
        <div><div class="title">لوحة القيادة</div><div class="sub">نظرة شاملة</div></div>
    </div>

    <div class="cards-grid">
        <div class="info-card"><span class="number" id="totalClients">0</span><div class="label">إجمالي العملاء</div></div>
        <div class="info-card"><span class="number" id="totalSalesAll">0</span><div class="label">إجمالي المبيعات</div></div>
        <div class="info-card"><span class="number" id="totalNetAll">0</span><div class="label">صافي الأرباح</div></div>
        <div class="info-card"><span class="number" id="totalDays">0</span><div class="label">أيام العمل</div></div>
    </div>

    <div class="chart-container">
        <canvas id="profitChart" style="width:100%; height:200px;"></canvas>
    </div>

    <div id="alertsContainer"></div>

    <div style="font-weight:600; margin-bottom:10px;"><i class="fas fa-clock"></i> آخر العملاء</div>
    <div id="recentClients"></div>

    <div class="bottom-nav">
        <a href="dashboard.html" class="nav-item active"><i class="fas fa-chart-pie"></i><span>الرئيسية</span></a>
        <a href="index.html" class="nav-item"><i class="fas fa-user-plus"></i><span>إضافة</span></a>
        <a href="vu.html" class="nav-item"><i class="fas fa-users"></i><span>العملاء</span></a>
        <a href="ads.html" class="nav-item"><i class="fas fa-coins"></i><span>يومي</span></a>
        <a href="total.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>ملخص</span></a>
    </div>

    <script>
        const STORAGE_CLIENTS = 'nova_clients';
        const STORAGE_DAILY = 'nova_daily';
        function getClients() { return JSON.parse(localStorage.getItem(STORAGE_CLIENTS) || '[]'); }
        function getDaily() { return JSON.parse(localStorage.getItem(STORAGE_DAILY) || '[]'); }
        function formatNumber(value) {
            if (value === null || value === undefined) return '0';
            if (Number.isInteger(value)) return value.toString();
            let num = value.toFixed(2);
            return num.endsWith('.00') ? parseInt(value).toString() : num;
        }

        function loadDashboard() {
            const clients = getClients();
            const daily = getDaily();

            const totalClients = clients.length;
            const totalSales = clients.reduce((a,c) => a + (c.amountPaidDZD || 0), 0);
            const totalNet = clients.reduce((a,c) => a + (c.netProfitDZD || 0), 0);
            const totalDays = daily.length;

            document.getElementById('totalClients').innerText = totalClients;
            document.getElementById('totalSalesAll').innerText = formatNumber(totalSales);
            document.getElementById('totalNetAll').innerText = formatNumber(totalNet);
            document.getElementById('totalDays').innerText = totalDays;

            // إشعارات العملاء غير المدفوعين منذ أكثر من 3 أيام
            const now = new Date();
            const threeDaysAgo = new Date(now.setDate(now.getDate() - 3)).toISOString().slice(0,10);
            const unpaidOld = clients.filter(c => !c.paid && c.date <= threeDaysAgo);
            const alertsDiv = document.getElementById('alertsContainer');
            if (unpaidOld.length > 0) {
                alertsDiv.innerHTML = `
                    <div class="alert-card">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div><strong>${unpaidOld.length}</strong> عميل غير مدفوع منذ أكثر من 3 أيام</div>
                    </div>`;
            } else {
                alertsDiv.innerHTML = '';
            }

            // آخر 5 عملاء
            const recent = [...clients].sort((a,b) => (a.date < b.date ? 1 : -1)).slice(0,5);
            let recentHtml = '';
            recent.forEach(c => {
                recentHtml += `
                <div class="recent-row">
                    <span><i class="fas fa-user"></i> ${c.pageName}</span>
                    <span>${c.date}</span>
                </div>`;
            });
            document.getElementById('recentClients').innerHTML = recentHtml || '<div class="recent-row">لا يوجد عملاء</div>';

            // رسم بياني لآخر 7 أيام (من daily)
            const last7 = daily.sort((a,b) => (a.date < b.date ? 1 : -1)).slice(0,7).reverse();
            const labels = last7.map(d => d.date.slice(5)); // MM-DD
            const profits = last7.map(d => d.netProfitDZD || 0);

            const ctx = document.getElementById('profitChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'صافي الربح (دج)',
                        data: profits,
                        backgroundColor: '#3b82f6',
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        loadDashboard();
    </script>
</body>
</html>